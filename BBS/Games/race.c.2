#include "bbs.h"

int
p_race()
{
  char bet[2],m1[8],*betname[4]={"¿}¿}","£«½÷","±j­ô","°ö°ö"};
  int save_pager,money;
  int p[4]={1,1,1,1},tmp;
  time_t now;
  char ch;
  int run,kill=0,flag=0,stop=4,i;

    setutmpmode(RACE);
    save_pager=currutmp->pager;
    currutmp->pager =2;
    while(-1)
    {
	flag=0;kill=0;stop=4;p[0]=p[1]=p[2]=p[3]=1;
	clear();
	do
	{
	    getdata(21, 0,"­n¤U¦h¤Ö©O(¤W­­10000)? «ö Enter Â÷¶}>", m1, 6, 1, 0);
	    money=atoi(m1);
	    if(money<0) money=0;
	} while(money>10000);
	if(!money)
	{
	    currutmp->pager = save_pager;
	    return 0;
	}
	if(money>cuser.money)
	{
	    pressanykey("§Aªº²{ª÷¤£°÷³á.. :)");
	    return 0;
	}
	demoney(money);

	clear();
	move(2,0);
	for(i=0;i<4;i++)
	    prints("%d.[1;3%dm%s[0m ",i+1,i+1,betname[i]);
	getdata(1,0,"§A­n©ã­þ°¦ ",bet,3,DOECHO,0);
	bet[1]='\0';
	if(strcmp(bet,"1")!=0 && strcmp(bet,"2")!=0 && strcmp(bet,"3")!=0 && strcmp(bet,"4")!=0)
	{
	    pressanykey("Bye Bye");
	    return 0;
	}
	move(4,0);
	outs("\n½Ð«ö k ¬°§A¿ïªº°Êª«¥[ªo");
	move(11,0);
	for(i=0;i<4;i++)
	    prints("%d.[1m%s[m |\n",i+1,betname[i]);
	outs("-------|--------------------------------------------------------------");

	move(6,7); outs("©b¶]");
	move(7,0); outs("«ö z ¥i¥á¥X«OÄÖ²y¤@¦¸!");
	while(p[0]<=30 && p[1]<=30 && p[2]<=30 && p[3]<=30)
	{
	    ch=igetch();
	    switch(ch)
	    {
		  case 'k':
		  case 'K':
			now=random();
			run=now%4+1;
			tmp=p[run-1];
			move(6,2);
			prints("%s",betname[run-1]);

			if(kill!=run)
			{
    			move((run+10),(tmp*2)+7);
    			prints("[1;3%dm¡½[0m",run);
			}
			if(run==kill && stop>0)
			{
				stop--;
				if(stop==0) kill=0;
				break;
			}
			if(run!=kill) p[run-1]++;
			break;
		  case'z':
 		  case'Z':
   			now=random();
			kill=now%4+1;
			if(flag==1) break;
			flag=1;
			move(17,0);
			prints("[1;36m«OÄÖ²y¯{¨ì%d¸¹[0m",kill);
			break;
		}           
	}

	move(20,0);
	outs("¹CÀ¸µ²§ô\n");
	for(i=0;i<4;i++)
	{
	    if(p[i]>30 && atoi(bet)==i+1) 
	    {
	    	money+=money*(p[i]-(p[0]+p[1]+p[2]+p[3])/4)/2;
		prints("®¥³ß§A©ã¤¤¤F%d¸¹ ¦@±o¼úª÷ %d ¤¸",i+1,money);
		inmoney(money);
		game_log(RACE,"À£¤¤¤F %s ÁÈ¤F %d ¤¸ ",betname[i],money);
		i=5;
	    }
	    if(i==3)
	    {
		outs("©êºp...§A¨S©ã¤¤");
		game_log(RACE,"¤@°¦³£¨SÀ£¤¤­ù ! ");
	    }
	}
	pressanykey(NULL);
    }
}
